<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ì–æ–ª–æ—Å—É–≤–∞–Ω–Ω—è –Ω–∞ Blockchain</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/4.5.0/web3.min.js"></script>
</head>
<body>
    {% extends 'base.html' %}
    {% block content %}
    <div style="width: 98%; margin-left: 1%; margin-top: 1%;">
    <h2 style="margin-left: 30%;">–ì–æ–ª–æ—Å—É–≤–∞–Ω–Ω—è: –≤–∏–±—ñ—Ä –Ω–∞–π–∫—Ä–∞—â–æ—ó –∫–Ω–∏–≥–∏</h2>

    <h3 style="margin-left: 20%;">–ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è MetaMask</h3>
    <button id="connectWallet" style="border: none; background-color: #BAFF39; border-radius: 8px; height: 40px; width: 250px; font-weight: bolder; margin-left: 20%;">–ü—ñ–¥–∫–ª—é—á–∏—Ç–∏ MetaMask</button>
    <h5 id="walletAddress" style="margin-left: 20%;">–ê–¥—Ä–µ—Å–∞: <span>-</span></h5>

    <h3 style="margin-left: 20%;">–î–æ–¥–∞—Ç–∏ –∫–Ω–∏–≥—É</h3>
    <form id="addCandidateForm" style="margin-left: 20%;">
        {% csrf_token %}
        <input type="text" id="candidateName" name="name" placeholder="–ù–∞–∑–≤–∞ –∫–Ω–∏–≥–∏" style="width: 400px;" required>
        <button type="submit" style="border: none; background-color: #BAFF39; border-radius: 8px; height: 40px; width: 250px; font-weight: bolder; margin-left: 2%;">–î–æ–¥–∞—Ç–∏</button>
    </form>

    <h3 style="margin-left: 20%;">–ü—Ä–æ–≥–æ–ª–æ—Å—É–≤–∞—Ç–∏</h3>
    <form id="voteForm" style="margin-left: 20%;">
        <input type="text" id="voteName" placeholder="–ù–∞–∑–≤–∞ –∫–Ω–∏–≥–∏" style="width: 400px;" required>
        <button type="submit" style="border: none; background-color: #BAFF39; border-radius: 8px; height: 40px; width: 250px; font-weight: bolder; margin-left: 2%;">–ì–æ–ª–æ—Å—É–≤–∞—Ç–∏</button>
    </form>

    <!--<h2>–†–µ–∑—É–ª—å—Ç–∞—Ç–∏</h2>
    <button onclick="getWinner()">–ü–µ—Ä–µ–º–æ–∂–µ—Ü—å</button>
    <p id="winner"></p>-->

    <h3 style="margin-left: 20%;">–ë–∞–ª–∞–Ω—Å –∫–æ–Ω—Ç—Ä–∞–∫—Ç—É</h3>
    <button onclick="getBalance()" style="border: none; background-color: #BAFF39; border-radius: 8px; height: 40px; width: 250px; font-weight: bolder; margin-left: 20%;">–î—ñ–∑–Ω–∞—Ç–∏—Å—è –±–∞–ª–∞–Ω—Å</button>
    <h5 id="balance" style="margin-left: 20%;"></h5>
   </div>
    <script>
        let userAccount = null;

        // üîπ –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è MetaMask
        document.getElementById("connectWallet").addEventListener("click", async function() {
            if (window.ethereum) {
                try {
                    const accounts = await ethereum.request({ method: "eth_requestAccounts" });
                    userAccount = accounts[0];
                    document.getElementById("walletAddress").innerHTML = `–ê–¥—Ä–µ—Å–∞: <span>${userAccount}</span>`;
                } catch (error) {
                    console.error("–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è MetaMask:", error);
                }
            } else {
                alert("–£—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å MetaMask!");
            }
        });

        // üîπ –î–æ–¥–∞–≤–∞–Ω–Ω—è –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ (–≤—ñ–¥–ø—Ä–∞–≤–∫–∞ Ethereum-–∞–¥—Ä–µ—Å–∏)
        document.getElementById("addCandidateForm").addEventListener("submit", function(event) {
            event.preventDefault();
            if (!userAccount) return alert("–°–ø–æ—á–∞—Ç–∫—É –ø—ñ–¥–∫–ª—é—á—ñ—Ç—å MetaMask!");

            const formData = new FormData();
            formData.append("name", document.getElementById("candidateName").value);
            formData.append("sender", userAccount);  // –ü–µ—Ä–µ–¥–∞—î–º–æ Ethereum-–∞–¥—Ä–µ—Å—É
            
            const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            fetch("/add_candidate/", {
                method: "POST",
                headers: { "X-CSRFToken": csrftoken },
                body: formData
            })
            .then(response => response.json())
            .then(data => alert(data.message));
        });

        // üîπ –ì–æ–ª–æ—Å—É–≤–∞–Ω–Ω—è –∑–∞ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞
        document.getElementById("voteForm").addEventListener("submit", function(event) {
            event.preventDefault();
            if (!userAccount) return alert("–°–ø–æ—á–∞—Ç–∫—É –ø—ñ–¥–∫–ª—é—á—ñ—Ç—å MetaMask!");

            const formData = new FormData();
            formData.append("name", document.getElementById("voteName").value);
            formData.append("sender", userAccount);  // –ü–µ—Ä–µ–¥–∞—î–º–æ Ethereum-–∞–¥—Ä–µ—Å—É
            
            fetch("/vote/", {
                method: "POST",
                body: formData
            })
            .then(response => response.json())
            .then(data => alert(data.message));
        });

        // üîπ –û—Ç—Ä–∏–º–∞–Ω–Ω—è –ø–µ—Ä–µ–º–æ–∂—Ü—è
        function getWinner() {
            fetch("/get_winner/")
            .then(response => response.json())
            .then(data => document.getElementById("winner").innerText = "–ü–µ—Ä–µ–º–æ–∂–µ—Ü—å: " + data.winner);
        }

        // üîπ –û—Ç—Ä–∏–º–∞–Ω–Ω—è –±–∞–ª–∞–Ω—Å—É –∫–æ–Ω—Ç—Ä–∞–∫—Ç—É
        function getBalance() {
            fetch("/get_balance/")
            .then(response => response.json())
            .then(data => document.getElementById("balance").innerText = "–ë–∞–ª–∞–Ω—Å: " + data.balance + " ETH");
        }

    </script>
    {% endblock %}
</body>
</html>
