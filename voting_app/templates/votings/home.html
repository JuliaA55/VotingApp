<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ì–æ–ª–æ—Å—É–≤–∞–Ω–Ω—è –Ω–∞ Blockchain</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/4.5.0/web3.min.js"></script>
</head>
<body>
    <h1>–ì–æ–ª–æ—Å—É–≤–∞–Ω–Ω—è –Ω–∞ Blockchain</h1>

    <h2>–ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è MetaMask</h2>
    <button id="connectWallet">–ü—ñ–¥–∫–ª—é—á–∏—Ç–∏ MetaMask</button>
    <p id="walletAddress">–ê–¥—Ä–µ—Å–∞: <span>-</span></p>

    <h2>–î–æ–¥–∞—Ç–∏ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞</h2>
    <form id="addCandidateForm">
        {% csrf_token %}
        <input type="text" id="candidateName" name="name" placeholder="–Ü–º'—è –∫–∞–Ω–¥–∏–¥–∞—Ç–∞" required>
        <button type="submit">–î–æ–¥–∞—Ç–∏</button>
    </form>

    <h2>–ü—Ä–æ–≥–æ–ª–æ—Å—É–≤–∞—Ç–∏</h2>
    <form id="voteForm">
        <input type="text" id="voteName" placeholder="–Ü–º'—è –∫–∞–Ω–¥–∏–¥–∞—Ç–∞" required>
        <button type="submit">–ì–æ–ª–æ—Å—É–≤–∞—Ç–∏</button>
    </form>

    <h2>–†–µ–∑—É–ª—å—Ç–∞—Ç–∏</h2>
    <button onclick="getWinner()">–ü–µ—Ä–µ–º–æ–∂–µ—Ü—å</button>
    <p id="winner"></p>

    <h2>–ë–∞–ª–∞–Ω—Å –∫–æ–Ω—Ç—Ä–∞–∫—Ç—É</h2>
    <button onclick="getBalance()">–î—ñ–∑–Ω–∞—Ç–∏—Å—è –±–∞–ª–∞–Ω—Å</button>
    <p id="balance"></p>

    <script>
        let userAccount = null;

        // üîπ –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è MetaMask
        document.getElementById("connectWallet").addEventListener("click", async function() {
            if (window.ethereum) {
                try {
                    const accounts = await ethereum.request({ method: "eth_requestAccounts" });
                    userAccount = accounts[0];
                    document.getElementById("walletAddress").innerHTML = `–ê–¥—Ä–µ—Å–∞: <span>${userAccount}</span>`;
                } catch (error) {
                    console.error("–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è MetaMask:", error);
                }
            } else {
                alert("–£—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å MetaMask!");
            }
        });

        // üîπ –î–æ–¥–∞–≤–∞–Ω–Ω—è –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ (–≤—ñ–¥–ø—Ä–∞–≤–∫–∞ Ethereum-–∞–¥—Ä–µ—Å–∏)
        document.getElementById("addCandidateForm").addEventListener("submit", function(event) {
            event.preventDefault();
            if (!userAccount) return alert("–°–ø–æ—á–∞—Ç–∫—É –ø—ñ–¥–∫–ª—é—á—ñ—Ç—å MetaMask!");

            const formData = new FormData();
            formData.append("name", document.getElementById("candidateName").value);
            formData.append("sender", userAccount);  // –ü–µ—Ä–µ–¥–∞—î–º–æ Ethereum-–∞–¥—Ä–µ—Å—É
            
            const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            fetch("/add_candidate/", {
                method: "POST",
                headers: { "X-CSRFToken": csrftoken },
                body: formData
            })
            .then(response => response.json())
            .then(data => alert(data.message));
        });

        // üîπ –ì–æ–ª–æ—Å—É–≤–∞–Ω–Ω—è –∑–∞ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞
        document.getElementById("voteForm").addEventListener("submit", function(event) {
            event.preventDefault();
            if (!userAccount) return alert("–°–ø–æ—á–∞—Ç–∫—É –ø—ñ–¥–∫–ª—é—á—ñ—Ç—å MetaMask!");

            const formData = new FormData();
            formData.append("name", document.getElementById("voteName").value);
            formData.append("sender", userAccount);  // –ü–µ—Ä–µ–¥–∞—î–º–æ Ethereum-–∞–¥—Ä–µ—Å—É
            
            fetch("/vote/", {
                method: "POST",
                body: formData
            })
            .then(response => response.json())
            .then(data => alert(data.message));
        });

        // üîπ –û—Ç—Ä–∏–º–∞–Ω–Ω—è –ø–µ—Ä–µ–º–æ–∂—Ü—è
        function getWinner() {
            fetch("/get_winner/")
            .then(response => response.json())
            .then(data => document.getElementById("winner").innerText = "–ü–µ—Ä–µ–º–æ–∂–µ—Ü—å: " + data.winner);
        }

        // üîπ –û—Ç—Ä–∏–º–∞–Ω–Ω—è –±–∞–ª–∞–Ω—Å—É –∫–æ–Ω—Ç—Ä–∞–∫—Ç—É
        function getBalance() {
            fetch("/get_balance/")
            .then(response => response.json())
            .then(data => document.getElementById("balance").innerText = "–ë–∞–ª–∞–Ω—Å: " + data.balance + " ETH");
        }

    </script>
</body>
</html>
